# 用户指南（Backend & Frontend）

本指南帮助你在本地快速运行与使用待办事项应用（含鉴权）。

---

## 1. 环境与工具

- Python 3.9+
- Node.js 18+
- 建议 macOS/Linux 使用 `bash/zsh`，Windows 使用 PowerShell 或 WSL

---

## 2. 后端 Backend（FastAPI + SQLite）

### 2.1 安装依赖

```bash
cd backend
python3 -m venv .venv
source .venv/bin/activate   # macOS/Linux
# Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

### 2.2 环境变量（可选）

- `DATABASE_URL`：数据库连接串（默认 `sqlite:///./database.db`）
- `JWT_SECRET`：JWT 密钥（默认 `dev-secret-change-me`，生产务必更改）
- `JWT_EXPIRE_MINUTES`：访问令牌过期分钟数（默认 `60`）

在 `backend/` 下创建 `.env` 或以 shell 导出环境变量均可。

### 2.3 启动服务

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

- Swagger 文档：`http://localhost:8000/docs`
- 健康检查：`http://localhost:8000/health`

如端口占用，可改用 `--port 8001`。

### 2.4 鉴权说明

- 首个注册用户自动获得 `admin` 角色
- 之后注册的为普通 `user`
- 管理员可执行批量删除、清空任务等危险操作

### 2.5 常见 API 操作

注册 → 登录 → 携带 Token 调用任务接口。

```bash
# 注册
curl -s -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"secret123"}'

# 登录（表单）
TOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d 'username=admin&password=secret123' | jq -r .access_token)

echo "TOKEN=$TOKEN"

# 新建任务
curl -s -X POST http://localhost:8000/api/v1/tasks \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"title":"学习 FastAPI"}'

# 查询任务
curl -s -X GET 'http://localhost:8000/api/v1/tasks?status=all' \
  -H "Authorization: Bearer $TOKEN"
```

### 2.6 运行测试

```bash
cd backend
source .venv/bin/activate
PYTHONPATH=$(pwd) pytest -q
```

---

## 3. 前端 Frontend（React + Vite + TypeScript）

### 3.1 安装与运行

```bash
cd frontend
npm install
npm run dev
```

- 默认地址：`http://localhost:3000`（若被占用，Vite 会自动切换端口，如 `3001`）

### 3.2 后端地址配置

前端默认指向 `http://localhost:8000`。如后端端口不同（如 8001），在 `frontend/` 下创建 `.env.local`：

```
VITE_API_BASE_URL=http://localhost:8001
```

保存后刷新页面。

### 3.3 使用步骤

1. 顶部 `AuthBar` 填写用户名与密码：
   - 点击“注册”：首次注册用户将成为管理员
   - 点击“登录”：成功后会在右侧显示当前用户与角色
2. 在输入框添加任务，点击“添加”
3. 在列表中：
   - 打勾或“完成/取消完成”切换任务状态
   - “删除”移除任务
4. 过滤/批量操作：
   - “全部/未完成/已完成”筛选任务
   - 管理员可“清除已完成/清除全部”

### 3.4 登录/注册结果提示

- 登录/注册时会在输入框右侧显示成功或失败提示（失败会附带后端返回原因）。

---

## 4. 目录结构速览

```
backend/
├── app/
│   ├── main.py         # FastAPI 入口
│   ├── models.py       # SQLAlchemy 模型（Task, User）
│   ├── database.py     # 数据库引擎/Session/初始化
│   ├── schemas.py      # Pydantic 模型
│   ├── auth.py         # JWT、密码哈希、依赖
│   └── routers/
│       ├── auth.py     # 注册/登录/me
│       └── tasks.py    # 任务 CRUD 与批量操作
├── tests/              # pytest 用例
└── requirements.txt

frontend/
├── src/
│   ├── App.tsx
│   ├── styles.css
│   ├── components/
│   │   ├── AuthBar.tsx
│   │   ├── TaskForm.tsx / TaskItem.tsx / TaskList.tsx / FilterBar.tsx
│   ├── hooks/
│   │   ├── useAuth.ts  # 登录态/Token 管理
│   │   └── useTasks.ts # 任务数据管理
│   └── services/
│       └── api.ts      # 后端接口封装+拦截器
└── vite.config.ts / tsconfig.json / package.json
```

---

## 5. 常见问题（FAQ）

- 端口被占用：
  - 后端：更换 `--port`（如 8001）或停止旧进程
  - 前端：Vite 自动换端口，或在命令中 `--port 3000`
- 401 Unauthorized：
  - 未登录或 Token 失效；请先注册并登录，前端会自动携带 Token
- 403 Forbidden：
  - 当前用户非管理员，无法执行清空/批量删除
- 422 参数错误：
  - 检查请求体是否符合接口校验（如标题不为空、长度限制）
- CORS 问题：
  - 后端已开启宽松 CORS；如跨域异常，请确认实际访问的端口与域名

---

## 6. 生产部署建议

- 后端：Docker 化部署，设置强随机 `JWT_SECRET`，使用持久化数据库（如 PostgreSQL）
- 前端：`npm run build` 后将 `dist/` 静态资源托管到 Nginx/CDN
- 反向代理：Nginx 统一转发前后端；开启 HTTPS 与基本安全头

---

祝使用愉快！
